# picview
使用python的pyglet,播放本地目录img下的所有图片，如果目录不存在会打开对话框选择目录(MAC,WINDOWS没有实现)
![](https://github.com/bjyitu/picview/blob/main/play.png)

![](https://github.com/bjyitu/picview/blob/main/thumb.png)

- 滑动幻灯片播放,底部进度条显示播放了多少进度
- 左右键上一张下一张，空格键继续播放,按1打开文件所在目录(MAC)
- 回车键进入、退出缩略图模式，上下键翻页


## 全局函数

### 1. choose_folder()
- **功能**：使用 macOS 的 AppleScript 显示文件夹选择对话框
- **返回**：用户选择的文件夹路径，取消时返回 "cancel"
- **实现方式**：通过 subprocess 执行 osascript 命令

### 2. validate_folder(path)
- **功能**：验证指定目录是否包含图片文件
- **参数**：path - 要验证的目录路径
- **返回**：布尔值，表示目录是否有效
- **检查**：目录是否存在且包含 .png、.jpg、.jpeg 或 .webp 文件

### 3. ease_out_quad(t)
- **功能**：二次缓动函数，用于平滑动画过渡
- **参数**：t - 时间进度值 (0-1)
- **返回**：缓动后的值

### 4. ease_out_cubic(t)
- **功能**：三次缓动函数，用于平滑动画过渡
- **参数**：t - 时间进度值 (0-1)
- **返回**：缓动后的值

### 5. ease_out_sine(t)
- **功能**：正弦缓动函数，用于平滑动画过渡
- **参数**：t - 时间进度值 (0-1)
- **返回**：缓动后的值

### 6. open_file_in_finder(file_path)
- **功能**：在 macOS 的 Finder 中打开文件所在文件夹并选中文件
- **参数**：file_path - 要打开的文件路径
- **实现方式**：使用 subprocess 执行 open -R 命令

### 7. update(dt)
- **功能**：定时更新函数，控制幻灯片自动播放
- **参数**：dt - 自上次调用以来的时间间隔
- **行为**：非手动模式下加载下一张图片并启动过渡动画

## SlideShow 类方法

### 初始化与配置方法

#### 8. __init__()
- **功能**：初始化幻灯片对象，设置各种状态和缓存
- **初始化内容**：
  - 批处理对象、当前/下一张图片引用
  - 动画状态、手动模式标志
  - 缩略图模式相关变量
  - 进度条设置
  - 多线程执行器和锁

### 图片处理方法

#### 9. apply_sharpening(img_path)
- **功能**：对图片应用锐化效果
- **参数**：img_path - 图片文件路径
- **处理流程**：
  - 使用 PIL 加载图片
  - 应用 SHARPEN 滤镜
  - 转换为 RGBA 模式
  - 垂直翻转适配 pyglet 坐标系
  - 转换为 pyglet 图像对象

#### 10. get_sprite_from_path(path, add_to_batch=True)
- **功能**：从图片路径创建精灵对象
- **参数**：path - 图片路径，add_to_batch - 是否添加到批处理
- **处理流程**：
  - 检查缓存，未缓存则加载并锐化图片
  - 清理超出限制的缓存
  - 创建精灵并缩放适配窗口
  - 居中显示精灵

#### 11. scale_to_fit(sprite, max_width, max_height)
- **功能**：缩放精灵以适应指定尺寸
- **参数**：sprite - 精灵对象，max_width/height - 最大宽高
- **算法**：保持宽高比，选择较小缩放比例

#### 12. center_sprite(sprite, max_width, max_height)
- **功能**：将精灵居中显示在指定区域内
- **参数**：sprite - 精灵对象，max_width/height - 区域宽高

### 缓存管理方法

#### 13. clean_cache()
- **功能**：清理图片缓存，保持缓存大小在限制范围内
- **策略**：移除最旧的缓存项，释放纹理资源

### 缩略图相关方法

#### 14. generate_thumbnail_data(path)
- **功能**：在后台线程中生成缩略图数据
- **参数**：path - 原始图片路径
- **返回**：包含路径、图像数据和尺寸的元组
- **处理**：缩放到指定尺寸，垂直翻转适配坐标系

#### 15. create_sprite_from_data(data)
- **功能**：从缩略图数据创建精灵对象
- **参数**：data - 包含路径、图像数据和尺寸的元组
- **返回**：创建的精灵对象

#### 16. generate_thumbnail_page(start_index)
- **功能**：生成缩略图页面（多线程版）
- **参数**：start_index - 起始图片索引
- **返回**：包含10张缩略图的精灵列表
- **处理**：检查缓存，为每张图片生成缩略图或创建占位符

#### 17. _thumbnail_ready(future, page_start, idx_in_page)
- **功能**：缩略图生成完成回调函数
- **参数**：future - 异步任务对象，page_start - 页面起始索引，idx_in_page - 页内索引
- **行为**：更新缩略图缓存，替换占位符

#### 18. _position_thumbnail(sprite, start_index, idx)
- **功能**：定位缩略图在网格中的位置
- **参数**：sprite - 缩略图精灵，start_index - 页面起始索引，idx - 图片索引
- **布局**：5列2行的网格，计算位置和缩放比例

#### 19. draw_thumbnails()
- **功能**：绘制当前页面的缩略图
- **处理**：生成并绘制缩略图页面

#### 20. _cleanup_thumbnails()
- **功能**：清理缩略图相关资源
- **处理**：
  - 取消进行中的任务
  - 清空数据缓存
  - 释放所有缩略图精灵和纹理资源
  - 清空缩略图缓存

### 幻灯片控制方法

#### 21. load_next()
- **功能**：加载下一张图片
- **处理**：计算下一张图片索引，创建下一张图片的精灵

#### 22. transition(dt)
- **功能**：启动图片过渡动画
- **参数**：dt - 时间间隔
- **处理**：设置过渡状态，启动滑入和淡出动画

#### 23. slide_left(dt)
- **功能**：实现图片从右侧滑入的动画
- **参数**：dt - 时间间隔
- **动画**：使用缓动函数平滑移动图片

#### 24. fade_out_old(dt)
- **功能**：实现旧图片淡出的动画
- **参数**：dt - 时间间隔
- **动画**：逐渐降低旧图片透明度

#### 25. show_next_manual()
- **功能**：手动切换到下一张图片
- **处理**：取消进行中的动画，设置手动模式，直接显示下一张图片

#### 26. show_prev_manual()
- **功能**：手动切换到上一张图片
- **处理**：取消进行中的动画，设置手动模式，直接显示上一张图片

#### 27. exit_thumbnail_mode()
- **功能**：退出缩略图模式，返回全屏查看
- **处理**：重置模式，清理缩略图资源，加载当前索引的图片

### 进度条方法

#### 28. update_progress(progress)
- **功能**：更新进度条显示
- **参数**：progress - 进度值 (0-1)
- **处理**：计算进度条尺寸和位置，更新背景和前景矩形

## 事件处理函数

### 29. on_draw()
- **功能**：窗口绘制事件处理函数
- **处理**：根据当前模式绘制相应内容（当前图片、过渡动画或缩略图）

### 30. on_resize(width, height)
- **功能**：窗口大小改变事件处理函数
- **参数**：width/height - 新的窗口尺寸
- **处理**：重新缩放和居中图片，缩略图模式下清理资源

### 31. on_key_press(symbol, modifiers)
- **功能**：键盘按键事件处理函数
- **参数**：symbol - 按键符号，modifiers - 修饰键
- **处理**：
  - Enter：切换缩略图模式
  - 方向键：缩略图模式下翻页，普通模式下切换图片
  - 空格：退出手动模式，恢复自动播放
  - 数字键1：在Finder中打开当前图片

### 32. on_close()
- **功能**：窗口关闭事件处理函数
- **处理**：停止所有时钟事件，关闭线程池，清理缓存，退出应用


1. **图片显示**：支持全屏查看图片，自动适应窗口大小
2. **幻灯片模式**：自动播放，带平滑过渡动画
3. **手动控制**：支持手动切换图片
4. **缩略图视图**：网格布局显示多张图片的缩略图
5. **图片处理**：应用锐化效果提升图片质量
6. **缓存管理**：智能缓存机制，平衡性能和内存使用
7. **多线程处理**：后台生成缩略图，保持界面响应
8. **进度指示**：显示当前播放进度
9. **系统集成**：支持在Finder中打开当前图片文件
